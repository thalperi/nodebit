<script type="text/html" data-template-name="nb-admin">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-heliaRepoPath"><i class="fa fa-folder"></i> Helia Repo Path</label>
        <input type="text" id="node-input-heliaRepoPath" placeholder="./helia-repo-admin">
    </div>
    <div class="form-row">
        <label for="node-input-heliaSwarmPort"><i class="fa fa-network-wired"></i> Helia Swarm Port</label>
        <input type="number" id="node-input-heliaSwarmPort" placeholder="4003">
    </div>
    <div class="form-row">
        <label for="node-input-heliaApiPort"><i class="fa fa-network-wired"></i> Helia API Port</label>
        <input type="number" id="node-input-heliaApiPort" placeholder="5003">
    </div>
    <div class="form-row">
        <label for="node-input-orbitDbPath"><i class="fa fa-database"></i> OrbitDB Path</label>
        <input type="text" id="node-input-orbitDbPath" placeholder="./orbitdb-admin">
    </div>
    <div class="form-row" id="helia-admin-status-info" style="margin-top: 5px; font-size: 0.9em; color: #555;">
        <span id="helia-admin-status-message"></span>
        <a href="#" id="helia-admin-status-retry" style="margin-left: 5px;">Retry</a>
    </div>
    <div class="form-row">
        <button id="node-button-start-helia" class="red-ui-button">Start Helia</button>
        <button id="node-button-stop-helia" class="red-ui-button">Stop Helia</button>
    </div>
</script>

<script type="text/html" data-help-name="nb-admin">
    <p>A Node-RED admin node for managing OrbitDB instances.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('nb-admin', {
        category: 'nodebit',
        color: '#77DD77',
        defaults: {
            name: {value: ""},
            heliaRepoPath: {value: "./helia-repo-admin"},
            heliaSwarmPort: {value: ""},
            heliaApiPort: {value: ""},
            orbitDbPath: {value: "./orbitdb-admin", required: true}
        },
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name || "nb-admin";
        },
        oneditprepare: function() {
            // Populate fields with current node values
            $("#node-input-heliaRepoPath").val(this.heliaRepoPath);
            $("#node-input-heliaSwarmPort").val(this.heliaSwarmPort);
            $("#node-input-heliaApiPort").val(this.heliaApiPort);
            $("#node-input-orbitDbPath").val(this.orbitDbPath);

            function checkHeliaAdminStatus() {
                $.getJSON("nodebit-admin-helia-status", function(data) {
                    if (data.running) {
                        $("#helia-admin-status-message").text(`Helia Running (Peer ID: ${data.peerId})`);
                        $("#node-button-start-helia").prop('disabled', true);
                        $("#node-button-stop-helia").prop('disabled', false);
                    } else {
                        $("#helia-admin-status-message").text("Helia Not Running.");
                        $("#node-button-start-helia").prop('disabled', false);
                        $("#node-button-stop-helia").prop('disabled', true);
                    }
                }).fail(function() {
                    $("#helia-admin-status-message").text("Helia Status Unknown.");
                    $("#node-button-start-helia").prop('disabled', false);
                    $("#node-button-stop-helia").prop('disabled', true);
                });
            }

            $("#helia-admin-status-retry").on("click", function(e) {
                e.preventDefault();
                checkHeliaAdminStatus();
            });

            $("#node-button-start-helia").on("click", function() {
                $.ajax({
                    url: "nodebit-admin-start-helia",
                    type: "POST",
                    success: function(response) {
                        RED.notify(response.message, "success");
                        checkHeliaAdminStatus();
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        RED.notify("Error starting Helia: " + xhr.responseText, "error");
                    }
                });
            });

            $("#node-button-stop-helia").on("click", function() {
                $.ajax({
                    url: "nodebit-admin-stop-helia",
                    type: "POST",
                    success: function(response) {
                        RED.notify(response.message, "success");
                        checkHeliaAdminStatus();
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        RED.notify("Error stopping Helia: " + xhr.responseText, "error");
                    }
                });
            });

            checkHeliaAdminStatus(); // Initial status check
        }
    });
</script>